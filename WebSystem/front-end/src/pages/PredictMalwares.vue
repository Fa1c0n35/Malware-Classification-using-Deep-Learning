<template>
  <div class="content">
    <div class="md-layout">
      <div class="md-layout-item">
        <md-card>
          <md-card-header data-background-color="green">
            <h4 class="title">List of all predicted malwares</h4>
          </md-card-header>
          <md-card-content>
            <md-table
              v-if="malware_predicted_list"
              v-model="malware_predicted_list"
              @md-selected="redirect_page"
              table-header-color="green"
              md-fixed-header
            >
              <md-table-row slot="md-table-row" slot-scope="{ item }" md-selectable="single">
                <md-table-cell md-label="SHA256">{{ item['SHA256'] }}</md-table-cell>
                <md-table-cell md-label="Time Added">{{ item['Time Added'] }}</md-table-cell>
                <md-table-cell md-label="Predicted As">{{ item['Predicted As'] }}</md-table-cell>
              </md-table-row>
            </md-table>
          </md-card-content>
        </md-card>
      </div>
    </div>

    <md-dialog :md-active.sync="showDialog">
      <md-dialog-title>Submit New Malware</md-dialog-title>
      <vue-dropzone ref="myVueDropzone" id="dropzone"
        @vdropzone-success="vsuccess" 
        :options="dropzoneOptions">
      </vue-dropzone>
    </md-dialog>

    <md-button
      class="md-fab md-fab-bottom-right"
      title="Predict New Malware!"
      v-tippy="{ placement : 'left',  arrow: true }"
      @click="showDialog = true"
    >
      <i class="fas fa-magic"></i>
    </md-button>
  </div>
</template>


<script>
import Vue from "vue";
import axios from "axios";
import VueTippy from "vue-tippy";
import moment, { utc } from "moment";
import vue2Dropzone from "vue2-dropzone";
import "vue2-dropzone/dist/vue2Dropzone.min.css";

Vue.use(VueTippy);

export default {
  components: {
    vueDropzone: vue2Dropzone
  },

  data() {
    return {
      malware_predicted_list: null,
      showDialog: false,
      dropzoneOptions: {
          url: 'http://127.0.0.1:5000/predict',
          thumbnailWidth: 150,
          maxFilesize: 20.0,
      }
    };
  },

  mounted() {
    var vm = this;
    axios
      .get("http://127.0.0.1:5000/get-list-predicted-malwares")
      .then(function(response) {
        vm.malware_predicted_list = response.data;
        for (var i = 0; i < vm.malware_predicted_list.length; i++) {
          var utc_time = vm.malware_predicted_list[i]["Time Added"];
          var local_time = moment
            .utc(utc_time)
            .local()
            .format("YYYY-MM-DD HH:mm:ss");
          vm.malware_predicted_list[i]["Time Added"] = local_time;
        }
      });
  },

  methods: {
    localize(t) {
      return new Date(t + " UTC").toString();
    },
    redirect_page(item) {
      this.$router.push({ path: `/show-predicted-malware/${item.SHA256}` });
    },
    vsuccess(file, response) {
      if (response.substring(0, 2) != "OK") {
        alert(response);
        this.$refs.myVueDropzone.removeAllFiles();
      } else {
        var returned_hash = response.split('\t')[1]
        this.$router.push({
            path: `/show-predicted-malware/${returned_hash}`
        });
      }
    },
  }
};
</script>

<style lang="scss" scoped>
.content {
  height: 100vh;
}

.md-fab,
.md-fab:focus {
  width: 55px !important;
  height: 55px !important;
  position: absolute !important;
  background-color: #ff5252 !important;
}

.md-fab:hover,
.md-fab:active:focus {
  background-color: #cc4141 !important;
}

v-spinner {
  padding-top: 20px;
}

.dialog-c {
  padding: 20px !important;
  width: 600px;
}
</style>