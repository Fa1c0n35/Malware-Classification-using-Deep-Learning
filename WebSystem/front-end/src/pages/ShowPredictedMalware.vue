<template>
  <div class="content">
    <md-toolbar class="md-primary">
      <span class="md-title">
        Processing result for
        <b>&nbsp;{{ filehash }}</b>
      </span>
    </md-toolbar>
    <md-card class="predict-card">
      <md-card-content>
        <span class="md-alignment-center">
          <h2>Predicted As</h2>&nbsp;&nbsp;
          <h1>
            <b>{{ predicted_malware }}</b>
          </h1>
          <br>
          <h6 v-if="time_added">
            Time Added:
            <b>{{ time_added }}</b>
          </h6>
          <h6>
            Engine Used:
            <b>Multi-layer Perceptron</b> with
            <b>{{ highest_conf }} </b> confidence
          </h6>
        </span>
      </md-card-content>
    </md-card>
    <chartjs-card
      v-if="chartData_softmax"
      chart_id="softmax_chart"
      :chartData="chartData_softmax"
      :chartType="chartType_softmax"
      :chartOptions="chartOptions_softmax"
      :chartHeight="150"
    >
      <template slot="content">
        <center>
          <h4 class="title">Softmax Probability for All Malware Classes</h4>
        </center>
      </template>
    </chartjs-card>
    <md-card>
      <md-card-header data-background-color="green">
        <h4 class="title">Behaviors Data for This Sample</h4>
      </md-card-header>
      <md-card-content v-if="behaviors_json">
        <json-tree :data="behaviors_json" :level="1"></json-tree>
      </md-card-content>
    </md-card>
    <div class="md-layout md-gutter">
      <div class="md-layout-item md-size-50">
        <md-card>
          <md-card-header data-background-color="orange">
            <h4 class="title">Bit-String</h4>
          </md-card-header>
          <md-card-content v-if="malware_bitstr" class="bitstring_c">
            <md-field>
              <md-textarea v-model="malware_bitstr" readonly></md-textarea>
            </md-field>
          </md-card-content>
        </md-card>
      </div>
      <div class="md-layout-item md-size-50">
        <md-card>
          <md-card-header data-background-color="red">
            <h4 class="title">Extracted Unigrams</h4>
          </md-card-header>
          <md-card-content v-if="malware_unigrams">
            <md-table
              class="unigram_c"
              v-model="malware_unigrams"
              table-header-color="green"
              md-fixed-header
            >
              <md-table-row slot="md-table-row" slot-scope="{ item }">
                <md-table-cell>{{ item.Unigram }}</md-table-cell>
              </md-table-row>
            </md-table>
          </md-card-content>
        </md-card>
      </div>
    </div>
    <div class="md-layout md-gutter">
      <div class="md-layout-item md-size-50">
        <md-card>
          <md-card-header data-background-color="blue">
            <h4 class="title">Generated Signatures</h4>
          </md-card-header>
          <md-card-content v-if="mal_signs">
            <json-tree :raw="mal_signs"></json-tree>
          </md-card-content>
        </md-card>
      </div>
      <div class="md-layout-item md-size-50">
        <md-card>
          <md-card-header data-background-color="purple">
            <h4 class="title">VirusTotal Results</h4>
          </md-card-header>
          <md-card-content v-if="vt_results">
            <md-table class="vt_c" v-model="vt_results" table-header-color="purple" md-fixed-header>
              <md-table-row slot="md-table-row" slot-scope="{ item }">
                <md-table-cell md-label="Antivirus">{{ item.Antivirus }}</md-table-cell>
                <md-table-cell md-label="Result">{{ item.Result }}</md-table-cell>
              </md-table-row>
            </md-table>
          </md-card-content>
        </md-card>
      </div>
    </div>
  </div>
</template>

<script>
import { ChartjsCard } from "@/components";
import axios from "axios";
import JsonTree from "vue-json-tree";
import palette from "google-palette";
import moment from "moment";

export default {
  components: {
    JsonTree,
    ChartjsCard
  },

  data() {
    return {
      chartData_softmax: null,
      chartType_softmax: "bar",
      chartOptions_softmax: {
        legend: { display: false },
        scales: {
          yAxes: [
            {
              ticks: {
                min: 0,
                beginAtZero: true
              }
            }
          ]
        }
      },

      behaviors_json: null,
      malware_bitstr: null,
      malware_unigrams: [],
      mal_signs: null,
      vt_results: [],
      highest_conf: 0,
      predicted_malware: null,

      time_added: null,
      filehash: this.$route.params.filehash,
      response_data: null
    };
  },

  created() {
    var vm = this;

    axios
      .get("http://127.0.0.1:5000/get-predicted-malware/" + vm.filehash)
      .then(function(response) {
        vm.response_data = response.data;

        // what malware our engine predicted
        vm.predicted_malware = vm.response_data[6];

        // when this malware added
        vm.time_added = moment.utc(vm.response_data[5]).local().format('YYYY-MM-DD HH:mm:ss');

        // behaviors into bitstring transformation
        vm.malware_bitstr = vm.response_data[3];

        // list of DAE generated signatures
        vm.mal_signs = vm.response_data[4];

        // for softmax graph
        var prob = JSON.parse(vm.response_data[7]);
        vm.chartData_softmax = {
          labels: Object.keys(prob),
          datasets: [
            {
              backgroundColor: vm.genColor("mpn65", Object.keys(prob).length),
              data: Object.values(prob)
            }
          ]
        };

        // highest probability
        vm.highest_conf = Math.max(...Object.values(prob)).toFixed(2);

        // show virustotal's av results
        var vt_json = JSON.parse(vm.response_data[1]).scans;
        for (var k in vt_json) {
          vm.vt_results.push({ Antivirus: k, Result: vt_json[k].result });
        }

        // sample's extracted unigrams
        JSON.parse(vm.response_data[2]).forEach(function(elem) {
          vm.malware_unigrams.push({ Unigram: elem });
        });

        // for json behaviors viewer
        vm.behaviors_json = JSON.parse(vm.response_data[1]).additional_info;
      });
  },

  methods: {
    genColor(name, count) {
      var colors = palette(name, count);
      for (var i = 0; i < colors.length; i++) {
        colors[i] = "#" + colors[i];
      }
      return colors;
    }
  }
};
</script>

<style lang="scss" scoped>
.predict-card {
  text-align: center;
}

.predict-card h1,
h2 {
  display: inline;
}

.bitstring_c {
  height: 250px;
}

.unigram_c {
  height: 220px;
}

.vt_c {
  height: 464px;
}

.json-tree-root {
  min-width: initial;
}

.md-textarea {
  height: 180px !important;
  padding: 0px;
}
</style>