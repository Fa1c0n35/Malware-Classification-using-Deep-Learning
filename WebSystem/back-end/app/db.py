
import sqlite3
import json


class sqlite_db():

    def __init__(self, sqlite_path):

        self.sqlite_path = sqlite_path
        self.conn = sqlite3.connect(self.sqlite_path, check_same_thread=False)
        self.c = self.conn.cursor()

        self.c.execute(
            'CREATE TABLE IF NOT EXISTS malwares('
            'sha256sum TEXT PRIMARY KEY UNIQUE, vt_data TEXT,'
            'unigrams TEXT, bitstring TEXT, generated_sign TEXT,'
            'time_added DATETIME, predicted TEXT, prediction_probability TEXT'
            ');')

    def insert_into_db(self, items):
        """
        Args:
            items: A list containing (sha256sum, vt_data, unigrams, bitstring, generated_sign, 
                                      predicted, prediction_probability)
        """

        for i in [1, 2, 4, 6]:
            items[i] = json.dumps(items[i])

        self.c.execute(
            "INSERT INTO malwares VALUES (?,?,?,?,?,DateTime('now'),?,?)", items)
        self.conn.commit()

    def get_partial_list_data(self):
        self.c.execute("SELECT sha256sum, time_added, predicted FROM malwares ORDER BY time_added DESC")
        return self.c.fetchall()

    def fetch_by_hash(self, file_hash):
        self.c.execute(
            "SELECT * FROM malwares WHERE sha256sum = ?", (file_hash,))
        return self.c.fetchone()
